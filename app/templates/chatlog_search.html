{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-12">
      <div class="card shadow">
        <div class="card-header bg-success text-white">
          <h5 class="card-title mb-0">
            <i class="bi bi-chat-dots me-2"></i>Chat Log Search
          </h5>
        </div>
        <div class="card-body">
          <div id="chatlog-search-container">
            <div class="text-center py-4">
              <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading search interface...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row justify-content-center mt-4">
    <div class="col-md-8">
      <div class="card shadow border mb-4">
        <div class="card-header bg-warning text-dark">
          <h5 class="mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Warning</h5>
        </div>
        <div class="card-body p-0">
          <div class="list-group list-group-flush">
            <div class="list-group-item d-flex align-items-start">
              <span class="fs-4 me-3 mt-1">üîí</span>
              <div>
                <h6 class="mb-1 fw-bold">This search function is not publicly available</h6>
                <p class="mb-1">Due to Twitch developer TOS, chatlogs cannot be distributed publicly. Therefore, only mods and admins can access this.</p>
              </div>
            </div>
            <div class="list-group-item d-flex align-items-start">
              <span class="fs-4 me-3 mt-1">üìù</span>
              <div>
                <h6 class="mb-1 fw-bold">Searches you do here are logged</h6>
                <p class="mb-1">The searches you do here in chatlogs are logged to discourage abuse</p>
              </div>
            </div>
            <div class="list-group-item d-flex align-items-start">
              <span class="fs-4 me-3 mt-1">üîê</span>
              <div>
                <h6 class="mb-1 fw-bold">Respect the users privacy</h6>
                <p class="mb-1">Although the chat messages are sent in public, the users still have right to privacy, and you should respect that. Don't be a creep</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="row justify-content-center mt-2">
    <div class="col-md-8">
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="alert alert-danger" role="alert">
            {% for message in messages %}
              {{ message }}
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script type="module">
import init, { render_chatlog_search } from "{{ url_for('static', filename='wasm/yappr.js', v=version) }}";

async function initChatlogSearch() {
  try {
    // Get WASM URL
    const version = document.querySelector('meta[name="version"]')?.getAttribute('content') || '';
    const wasmUrl = `{{ url_for('static', filename='wasm/yappr_bg.wasm') }}${version ? `?v=${version}` : ''}`;
    
    await init(wasmUrl);
    
    // Prepare channels data
    const channelsData = {{ channels | tojson }};
    
    // Render the chatlog search component
    render_chatlog_search(JSON.stringify(channelsData), 'chatlog-search-container');
    
  } catch (error) {
    console.error('Failed to initialize chatlog search:', error);
    const container = document.getElementById('chatlog-search-container');
    if (container) {
      container.innerHTML = `
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle me-2"></i>
          Failed to load search interface. Please refresh the page.
        </div>
      `;
    }
  }
}

document.addEventListener('DOMContentLoaded', initChatlogSearch);
</script>
{% endblock %}
