{% extends "base.html" %}

{% block content %}
<div class="resizable-parent">
  <div class="resizable-container">
    <!-- Video Player Column -->
    <div class="resizable-player">
      <div class="card">
        <div class="card-body shadow p-0" style="min-height: 480px;">
          <div id="player-area">
            <div class="ratio ratio-16x9" id="player-container" style="display: none;" hx-swap-oob="true" data-clip-id="">
              <!-- Player will be loaded here via HTMX -->
            </div>
            <div id="initial-message" class="ratio ratio-16x9 d-flex justify-content-center align-items-center">
              <div class="text-center p-4">
                <p class="lead">Select a clip from the "Up Next" list to start watching</p>
                <p id="motd" class="motd">{{ motd }}</p>
              </div>
            </div>
          </div>
        </div>
        <div class="card-footer bg-transparent p-0">
          <div id="clip-strip" class="d-flex align-items-stretch flex-nowrap overflow-hidden">
            <div id="clip-details" class="d-flex align-items-stretch flex-nowrap overflow-hidden flex-grow-1">
              <!-- Clip details will be loaded here via HTMX -->
            </div>
            <div id="rating-buttons" class="d-flex gap-2 flex-shrink-0 me-2 align-self-center" style="display:none">
              <button 
                class="btn btn-danger rating-ghost bad rating-buttons"
                id="mark-bad-btn"
                data-bs-toggle="tooltip"
                style="display: none;"
                title="Mark as bad clip and move to next"
                onclick="markCurrentWatchedWithRating(-1.0)">
                <i class="bi bi-hand-thumbs-down-fill"></i> Bad
              </button>
              <button 
                class="btn btn-success rating-ghost good rating-buttons"
                id="mark-good-btn"
                data-bs-toggle="tooltip"
                style="display: none;"
                title="Mark as good clip and move to next"
                onclick="markCurrentWatchedWithRating(1.0)">
                <i class="bi bi-hand-thumbs-up-fill"></i> Good
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div class="resize-handle" id="resize-handle"></div>

    <!-- Queue List Column -->
    <div class="resizable-queue">
      <div class="card shadow">
        <div class="card-header">
          <!-- Tab structure with Bootstrap buttons -->
          <ul class="nav nav-tabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button" role="tab" aria-controls="upcoming" aria-selected="true">
                <i class="bi bi-collection-play"></i> Up Next
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab" aria-controls="history" aria-selected="false">
                <i class="bi bi-clock-history"></i> History
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="options-tab" data-bs-toggle="tab" data-bs-target="#options" type="button" role="tab" aria-controls="options" aria-selected="false"
                     hx-get="/clip_queue/settings"
                     hx-trigger="click"
                     hx-swap="none">
                <i class="bi bi-gear"></i> Options
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" type="button" role="tab" aria-controls="help" aria-selected="false">
                <i class="bi bi-question-circle"></i> Help
              </button>
            </li>
          </ul>  
          <!-- Search inputs for both tabs -->
          <div class="mb-2">
            <div id="upcoming-search" class="input-group input-group-sm">
              <span class="input-group-text bg-transparent border-end-0">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" id="upcoming-search-input" class="form-control border-start-0" 
                    placeholder="Search clips..." 
                    hx-get="/clip_queue/items" 
                    hx-target="#queue-items" 
                    hx-trigger="keyup changed delay:500ms" 
                    name="search"
                    hx-include="#prefer-short-toggle"
                    hx-indicator="#upcoming-search-spinner">
              <span id="upcoming-search-spinner" class="htmx-indicator spinner-border spinner-border-sm" role="status"></span>
            </div>
            
            <div id="history-search" class="input-group input-group-sm" style="display:none;">
              <span class="input-group-text bg-transparent border-end-0">
                <i class="bi bi-search"></i>
              </span>
              <input type="text" id="history-search-input" class="form-control border-start-0" 
                    placeholder="Search history..." 
                    hx-get="/clip_queue/items" 
                    hx-target="#history-items" 
                    hx-trigger="keyup changed delay:500ms"
                    hx-include="#prefer-short-toggle" 
                    name="search"
                    hx-vals='{"show_history": "true"}'                      
                    hx-indicator="#history-search-spinner">
              <span id="history-search-spinner" class="htmx-indicator spinner-border spinner-border-sm" role="status"></span>
            </div>
          </div>
        </div>
        <div class="card-body">
          <div class="tab-content" id="queue-tabs-content">
            <div class="tab-pane fade show active" id="upcoming" role="tabpanel" aria-labelledby="upcoming-tab">
              <div id="queue-items" class="overflow-auto custom-scrollbar" 
                   style="max-height: calc(95vh - 14rem);" 
                   hx-get="/clip_queue/items?show_history=false&page=1" 
                   hx-trigger="load delay:100ms, queue_update from:body, click from:#upcoming-tab"
                   hx-swap="innerHTML">
                <!-- Queue items will be loaded here via HTMX -->
              </div>
            </div>
            <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
              <div id="history-items" class="overflow-auto custom-scrollbar" 
                   style="max-height: calc(95vh - 14rem);" 
                   hx-get="/clip_queue/items?show_history=true&page=1" 
                   hx-trigger="click from:#history-tab, history_update from:body"
                   hx-swap="innerHTML">
                <!-- History items will be loaded here via HTMX -->
              </div>
            </div>
            <div class="tab-pane fade" id="options" role="tabpanel" aria-labelledby="options-tab">
              <div class="p-3 overflow-auto custom-scrollbar" style="max-height: calc(95vh - 14rem);">
                <div class="card mb-3">
                  <div class="card-body">
                    <h5 class="card-title">Queue Settings</h5>
                    <form id="platform-settings-form" 
                          hx-post="/clip_queue/settings" 
                          hx-swap="none" 
                          hx-trigger="change delay:200ms"
                          hx-indicator="#platforms-spinner"
                          hx-on::after-request="updatePlatformsStatus(event)">
                      <!-- Weight Settings Section -->
                      <div class="mb-4">
                        <h6 class="mb-3">
                          <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#weight-settings-collapse" aria-expanded="false" aria-controls="weight-settings-collapse">
                            <i class="bi bi-sliders"></i> Priority & Sorting Settings
                          </button>
                        </h6>
                        <div class="collapse" id="weight-settings-collapse">
                          <div class="card card-body">
                             <!-- Reset Button -->
                            <div class="row mb-3">
                              <div class="col-12 d-flex justify-content-between">
                                <button type="button" class="btn btn-sm btn-outline-info" 
                                        id="toggle-preview-button"
                                        onclick="togglePreviewInPlayer()">
                                  <i class="bi bi-eye"></i> <span id="preview-button-text">Show Preview</span>
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-warning" 
                                        hx-get="/clip_queue/default_weight_settings" 
                                        hx-target="#weight-settings-collapse .card-body"
                                        hx-swap="innerHTML"
                                        hx-confirm="Reset all priority settings to default values?"
                                        hx-on::after-request="if(document.getElementById('preview-active')) updatePreview();">
                                  <i class="bi bi-arrow-clockwise"></i> Reset to Defaults
                                </button>
                              </div>
                            </div>
                            <!-- Boolean Preferences -->
                            <div class="row mb-3">
                                <div class="form-check form-switch mb-2">
                                  <input class="form-check-input weight-setting toggle-control" type="checkbox" id="prefer-shorter" name="prefer_shorter" 
                                         hx-on:change="if(document.getElementById('preview-active')) updatePreview();">
                                  <label class="form-check-label" for="prefer-shorter">
                                    Prefer Shorter Content
                                    <small class="text-muted d-block">Boost clips under X seconds in duration</small>
                                  </label>
                                </div>
                                <div id="prefer-shorter-settings" class="ms-4 mb-3" style="display: none;">
                                  <div class="mb-3">
                                    <label for="prefer-shorter-intensity" class="form-label">
                                      Short Content Intensity
                                      <span class="badge bg-secondary" id="prefer-shorter-intensity-value">0.5</span>
                                    </label>
                                    <input type="range" class="form-range weight-setting" min="0" max="1" step="0.1" id="prefer-shorter-intensity" name="prefer_shorter_intensity" value="0.5" style="width: 50%;">
                                  </div>
                                  <div class="mb-3">
                                    <label for="short-clip-threshold" class="form-label">
                                      Short Clip Threshold (seconds)
                                      <span class="badge bg-secondary" id="short-clip-threshold-value">60</span>
                                    </label>
                                    <input type="range" class="form-range weight-setting" min="10" max="300" step="10" id="short-clip-threshold" name="short_clip_threshold_seconds" value="60" style="width: 50%;">
                                    <div class="form-text">Duration threshold for considering a clip 'short'</div>
                                  </div>
                                </div>
                                
                                <div class="form-check form-switch mb-2">
                                  <input class="form-check-input weight-setting toggle-control" type="checkbox" id="keep-fresh" name="keep_fresh">
                                  <label class="form-check-label" for="keep-fresh">
                                    Keep Fresh
                                    <small class="text-muted d-block">Prioritize recently submitted content</small>
                                  </label>
                                </div>
                                <div id="keep-fresh-settings" class="ms-4 mb-3" style="display: none;">
                                  <div class="mb-3">
                                    <label for="keep-fresh-intensity" class="form-label">
                                      Freshness Intensity
                                      <span class="badge bg-secondary" id="keep-fresh-intensity-value">0.5</span>
                                    </label>
                                    <input type="range" class="form-range weight-setting" min="0" max="1" step="0.1" id="keep-fresh-intensity" name="keep_fresh_intensity" value="0.5" style="width: 50%;">
                                  </div>
                                  <div class="mb-3">
                                    <label for="freshness-window" class="form-label">
                                      Freshness Window (minutes)
                                      <span class="badge bg-secondary" id="freshness-window-value">30</span>
                                    </label>
                                    <input type="range" class="form-range weight-setting" min="5" max="120" step="5" id="freshness-window" name="freshness_window_minutes" value="30" style="width: 50%;">
                                    <div class="form-text">Time window for considering content 'fresh'</div>
                                  </div>
                                </div>
                                
                                <div class="form-check form-switch mb-2">
                                  <input class="form-check-input weight-setting toggle-control" type="checkbox" id="ignore-popularity" name="ignore_popularity">
                                  <label class="form-check-label" for="ignore-popularity">
                                    Ignore Popularity
                                    <small class="text-muted d-block">Multiple submissions won't increase priority</small>
                                  </label>
                                </div>
                                <div id="ignore-popularity-settings" class="ms-4 mb-3" style="display: none;">
                                  <div class="mb-3">
                                    <label for="ignore-popularity-intensity" class="form-label">
                                      Popularity Reduction Intensity
                                      <span class="badge bg-secondary" id="ignore-popularity-intensity-value">1</span>
                                    </label>
                                    <input type="range" class="form-range weight-setting" min="0" max="1" step="0.1" id="ignore-popularity-intensity" name="ignore_popularity_intensity" value="1" style="width: 50%;">
                                  </div>
                                </div>
                                
                                <div class="form-check form-switch mb-2">
                                  <input class="form-check-input weight-setting toggle-control" type="checkbox" id="viewer-priority" name="viewer_priority">
                                  <label class="form-check-label" for="viewer-priority">
                                    Viewer Priority
                                    <small class="text-muted d-block">Higher priority for VIP/MOD submissions</small>
                                  </label>
                                </div>
                                <div id="viewer-priority-settings" class="ms-4 mb-3" style="display: none;">
                                  <div class="mb-3">
                                    <label for="viewer-priority-intensity" class="form-label">
                                      Viewer Priority Intensity
                                      <small class="text-muted d-block">Higher priority for VIP/MOD submissions</small>
                                      <span class="badge bg-secondary" id="viewer-priority-intensity-value">0.5</span>
                                    </label>
                                    <input type="range" class="form-range weight-setting" min="0" max="1" step="0.1" id="viewer-priority-intensity" name="viewer_priority_intensity" value="0.5" style="width: 50%;">
                                  </div>
                                </div>
                            </div>
                            
                           
                            
                          </div>
                        </div>
                      </div>
                      
                      <div class="mb-4" style="display: none;">
                        <div class="form-check form-switch">
                          <input class="form-check-input" type="checkbox" id="prefer-short-toggle" name="prefer_shorter_content">
                          <label class="form-check-label" for="prefer-short-toggle">Prefer short content</label>
                        </div>
                      </div>
                      
                      <h5 class="card-title">Allowed Platforms</h5>
                      <div class="mb-3">
                        <div class="d-flex gap-2 mb-2">
                          <div class="form-check">
                            <input class="form-check-input platform-toggle" type="checkbox" id="platform-youtube_video" name="platforms" value="youtube_video" checked>
                            <label class="form-check-label" for="platform-youtube_video">YouTube Videos</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input platform-toggle" type="checkbox" id="platform-youtube_short" name="platforms" value="youtube_short" checked>
                            <label class="form-check-label" for="platform-youtube_short">YouTube Shorts</label>
                          </div>
                        </div>
                        <div class="d-flex gap-2 mb-2">
                          <div class="form-check">
                            <input class="form-check-input platform-toggle" type="checkbox" id="platform-youtube_clip" name="platforms" value="youtube_clip" checked>
                            <label class="form-check-label" for="platform-youtube_clip">YouTube Clips</label>
                          </div>
                          <div class="form-check">
                            <input class="form-check-input platform-toggle" type="checkbox" id="platform-twitch_video" name="platforms" value="twitch_video" checked>
                            <label class="form-check-label" for="platform-twitch_video">Twitch Videos</label>
                          </div>
                        </div>
                        <div class="d-flex gap-2 mb-3">
                          <div class="form-check">
                            <input class="form-check-input platform-toggle" type="checkbox" id="platform-twitch_clip" name="platforms" value="twitch_clip" checked>
                            <label class="form-check-label" for="platform-twitch_clip">Twitch Clips</label>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">Queue Management</h5>
                    <button class="btn btn-danger" 
                            data-bs-toggle="tooltip" 
                            data-bs-placement="top" 
                            title="This will remove all clips from your queue by marking them as skipped"
                            hx-post="/clip_queue/skip_all"
                            hx-confirm="This will mark all clips as skipped, which means they will never appear in queue again. Are you sure?"
                            hx-swap="none"
                            hx-on::after-request="htmx.trigger('#queue-items', 'queue_update');">
                      <i class="bi bi-skip-forward-fill"></i> Clear queue
                    </button>
                  </div>
                </div>
              </div>
            </div>
            <div class="tab-pane fade" id="help" role="tabpanel" aria-labelledby="help-tab">
              <div class="p-3 overflow-auto custom-scrollbar" style="max-height: calc(95vh - 14rem);">
                <div class="card mb-3">
                  <div class="card-body">
                    <h5 class="card-title"><i class="bi bi-question-circle"></i> How to Use the Queue</h5>
                    <div class="mb-3">
                      <ul class="list-unstyled">
                        <li><i class="bi bi-play-circle text-primary"></i> Click any clip to start watching</li>
                        <li><i class="bi bi-play-circle text-primary"></i> Clicking on a clip wil automatically mark the current one as watched with a neutral score</li>
                        <li><i class="bi bi-hand-thumbs-up text-success"></i> Use the <strong>Good</strong> button to rate clips positively</li>
                        <li><i class="bi bi-hand-thumbs-down text-danger"></i> Use the <strong>Bad</strong> button to rate clips negatively</li>
                        <li><i class="bi bi-trash text-danger"></i> Skip clips you don't want to watch using the trash icon</li>
                        <li><i class="bi bi-arrow-left"></i> You can resize the clip queue window by dragging the edge of the player</li>
                        <li><i class="bi bi-person"></i> Click on a username to view the user's profile</li>
                        <li><i class="bi bi-question-circle"></i> On clips, click on the question mark to view the clip's context</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div id="userModalContent">
      <!-- Modal content will be loaded here via HTMX -->
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/clip-queue-v2.js', v=version) }}"></script>
{% endblock %}
