{% extends 'base.html' %}

{% block content %}
  {% if not broadcaster.hidden or (broadcaster.hidden and current_user.has_permission(["admin", "mod"]) or current_user.has_broadcaster_id(broadcaster.id) or current_user.is_moderator(broadcaster.id)) %}
    <div class="container">
      <h1>{{ broadcaster.name }}</h1>
      {% if broadcaster.hidden %}
        <h2>Hidden for regular users</h2>
      {% endif %}
      {% with messages = get_flashed_messages() %}
        {% if messages %}
          <div class="alert alert-success" role="alert">
            {% for message in messages %}
              {{ message }}
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
      <table class="table table-striped">
        <thead>
          <tr>
            <th scope="col">Channel ID</th>
            <th scope="col">Channel External ID</th>
            <th scope="col">Display Name</th>
            <th scope="col">Platform</th>
            <th scope="col">ID</th>
            <th scope="col">Channel Type</th>
            <th scope="col">Linked</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for channel in channels %}
          <tr>
            <td>{{ channel.id }}</td>
            <td>{{ channel.platform_channel_id }}</td>
            <td>{{ channel.name }}</td>
            <td>{{ channel.platform.name }}</td>
            <td>{{ channel.platform_ref }}</td>
            <td>{{ channel.main_video_type.name }}</td>
            <td>{{ channel.source_channel.id }}</td>
            <td>
              <a class="btn btn-primary" role="button" href="{{ url_for('channel_get_videos', channel_id=channel.id) }}">Go to Channel</a>

              {% if current_user.has_permission(["admin"]) or current_user.has_broadcaster_id(broadcaster.id) %}
                <a class="btn btn-primary" role="button" href = "{{ url_for('channel_fetch_details', channel_id=channel.id) }}">Update channel details</button>
                <a class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this channel? All transcription work will be lost')" role="button" href="{{ url_for('channel_delete', channel_id=channel.id) }}">Delete Channel</a>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <hr>
      {% if current_user.has_permission(["admin", "mod"]) or current_user.has_broadcaster_id(broadcaster.id) or current_user.is_moderator(broadcaster.id) %}
        <h2>Broadcaster Settings</h2>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#broadcasterSettingsModal">
          Configure Broadcaster Settings
        </button>
        
        <div class="modal fade" id="broadcasterSettingsModal" tabindex="-1" aria-labelledby="broadcasterSettingsModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="broadcasterSettingsModalLabel">Broadcaster Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              {% for channel in broadcaster.channels %}
                <form action="{{ url_for('channel_settings_update', channel_id=channel.id) }}" method="post">
                  <div class="modal-body">
                    <h5 class="modal-title" id="broadcasterSettingsModalLabel">Twitch bot settings for {{ channel.name }}</h5>
                    <div class="mb-3 form-check">
                      <input type="checkbox" class="form-check-input" id="chat_collection_enabled{{ channel.id }}" name="chat_collection_enabled" {% if channel.settings and channel.settings.chat_collection_enabled or channel.settings and channel.settings.content_queue_enabled %}checked{% endif %}>
                      <label class="form-check-label" for="chat_collection_enabled{{ channel.id }}" title="This collect chat logs for this channel">Enable Chat Collection</label>
                      <div class="form-text">Collect chat logs for this channel</div>
                    </div>
                    <div class="mb-3 form-check">
                      <input type="checkbox" class="form-check-input" id="content_queue_enabled{{ channel.id }}" name="content_queue_enabled" {% if channel.settings and channel.settings.content_queue_enabled %}checked{% endif %}>
                      <label class="form-check-label" for="content_queue_enabled{{ channel.id }}" title="This will look for clips in twitch chat on this channel">Enable Content Queue</label>
                      <div class="form-text">Look for clips in twitch chat on this channel, automatically enables Chat Collection</div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                  </div>
                </form>
              {% endfor %}
              {% if current_user.has_permission(["admin"]) %}
              <form action="{{ url_for('broadcaster_settings_update', broadcaster_id=broadcaster.id) }}" method="post">
                <div class="modal-body">
                  <h5 class="modal-title">Discord bot settings</h5>
                  <div class="mb-3">
                    <label for="discord_channel_id">Discord Channel ID</label>
                    <input type="number" class="form-control" id="discord_channel_id" name="discord_channel_id" 
                           value="{{ broadcaster.settings.linked_discord_channel_id if broadcaster.settings else '' }}" 
                           placeholder="Enter Discord Channel ID">
                    <div class="form-text">The ID of the Discord channel where clips should be picked up by the <a href="https://discord.com/oauth2/authorize?client_id=1359399600733290586">YappR Discord bot</a></div>
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
              </form>
              {% endif %}
              {% if current_user.has_permission(["admin"]) or current_user.has_broadcaster_id(broadcaster.id) %}
                <hr>
                <div class="container mb-3 mt-3"> 
                  <h5>General Settings</h5>
                  <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="hidden" name="hidden" {% if broadcaster.hidden %}checked{% endif %}>
                    <label class="form-check-label" for="hidden">Hide Broadcaster</label>
                    <div class="form-text">When hidden, this broadcaster will only be visible to admins and the broadcaster themself</div>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      {% endif %}


      {% if current_user.has_permission(["admin"]) or current_user.has_broadcaster_id(broadcaster.id) %}
        <a class="btn btn-primary" data-bs-toggle="collapse" href="#collapseAddChannel" role="button" aria-expanded="false" aria-controls="collapseExample">
          Add new channel
        </a>

        <div class="collapse" id="collapseAddChannel">
        <hr>

        <form action="{{ url_for('channel_create') }}" method="post">
          <label for="platform_id">Platform:</label>
          <select id="platform_id" name="platform_id" class="form-select">
            {% for platform in platforms %}
              <option value="{{ platform.id }}">{{ platform.name }}</option>
            {% endfor %}
          </select>

          <label for="channel_type">Channel Type</label>
          <select id="channel_type" name="channel_type" class="form-select">
            {% for video_type in video_types %}
              <option value="{{ video_type.name }}">{{ video_type.name }}</option>
            {% endfor %}
          </select>

          <label for="name">Display Name:</label>
          <input type="text" id="name" name="name" class="form-control" pattern="[A-Za-z0-9_.][A-Za-z0-9_. ]*" required placeholder="Testies VOD channel" required title="Only A-Z, _ and numbers allowed">
          <label for="platform_ref">Channel ID in platform</label>
          <input type="text" id="platform_ref" name="platform_ref" class="form-control" pattern="[A-Za-z0-9_.][A-Za-z0-9_.]*" required placeholder="" required title="Only A-Z or numbers allowed, remove @ from youtube tag">

          <input
            type="hidden"
            id="broadcaster_id"
            name="broadcaster_id"
            value="{{ broadcaster.id }}"
          >
          </br>
          <button type="submit" class="btn btn-primary">Save</button>
        </form>
      </div>
     {% endif %}
    {% if current_user.has_permission(["admin"]) or current_user.has_broadcaster_id(broadcaster.id) %}
      <a class="btn btn-danger" onclick="return confirm('Are you sure you want to delete this broadcaster? All channels and transcription work will be lost')" href="{{ url_for('broadcaster_delete', broadcaster_id=broadcaster.id) }}">Delete Broadcaster</a>
    {% elif current_user.has_permission(["mod"]) or current_user.is_moderator(broadcaster.id) %}
      <a class="btn btn-danger" onclick="return confirm('Only broadcasters themselves or administrators can delete broadcasters')" href="#">Delete Broadcaster</a>
    {% endif %}
    </div>
  {% else %}
    <p> What are you doing here?</p>
  {% endif %}
{% endblock %}
