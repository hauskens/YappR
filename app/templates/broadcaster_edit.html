{% extends 'base.html' %}

{% block content %}
<style>
  .htmx-indicator {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 255, 255, 0.9);
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
  }
  .htmx-indicator.htmx-request { display: block; }
  
  .channel-card {
    border-left: 4px solid;
  }
  .channel-card.twitch { border-left-color: #9146FF; }
  .channel-card.youtube { border-left-color: #FF0000; }
  
  .platform-badge.twitch,
  .channel-type-badge.stream { color: #9146FF; }
  .platform-badge.youtube { color: #FF0000; }
  .channel-type-badge.vod { color: #6f42c1; }
  
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }
  .stat-item {
    text-align: center;
    padding: 1rem;
    border-radius: 8px;
  }
  
  .section-header {
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
  }
  
  .add-channel-btn {
    border: 2px dashed #6c757d;
    background: transparent;
    transition: all 0.3s ease;
  }
  .add-channel-btn:hover {
    border-color: #007bff;
  }
  
  .hold-to-delete {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .hold-to-delete .progress-overlay {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, rgba(220,53,69,0.3) 0%, rgba(220,53,69,0.6) 100%);
    width: 0%;
    transition: width 0.1s linear;
    z-index: 1;
  }
  
  .hold-to-delete .btn-content {
    position: relative;
    z-index: 2;
  }
  
  .hold-to-delete:active {
    transform: scale(0.98);
  }
  
  .hold-to-delete.completing {
    background-color: #dc3545 !important;
    border-color: #dc3545 !important;
    color: white !important;
  }
  
  .hold-to-delete-dropdown {
    position: relative;
    overflow: hidden;
    transition: all 0.3s ease;
  }
  
  .hold-to-delete-dropdown .progress-overlay {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, rgba(220,53,69,0.3) 0%, rgba(220,53,69,0.6) 100%);
    width: 0%;
    transition: width 0.1s linear;
    z-index: 1;
  }
  
  .hold-to-delete-dropdown .dropdown-content {
    position: relative;
    z-index: 2;
  }
  
  .hold-to-delete-dropdown:active {
    transform: scale(0.98);
  }
  
  .hold-to-delete-dropdown.completing {
    background-color: #dc3545 !important;
    color: white !important;
  }
</style>

<div class="container-fluid">
  <!-- Header Section -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="d-flex align-items-center">
        <div class="me-3">
          {% if broadcaster.profile_image_url %}
            <img src="{{ broadcaster.profile_image_url }}" 
                 class="rounded-circle" 
                 style="width: 3.5rem; height: 3.5rem; object-fit: cover;"
                 alt="{{ broadcaster.name }} profile image">
          {% else %}
            <div class="rounded-circle bg-primary bg-gradient d-inline-flex align-items-center justify-content-center" style="width: 3.5rem; height: 3.5rem;">
              <i class="bi bi-broadcast text-white fs-4"></i>
            </div>
          {% endif %}
        </div>
        <div class="flex-grow-1">
          <h1 class="card-title mb-1">{{ broadcaster.name }}</h1>
          <div class="d-flex align-items-center gap-2">
            <small class="text-muted">
              <i class="bi bi-collection me-1"></i>{{ channels | length }} channel{{ 's' if channels | length != 1 else '' }}
            </small>
            {% if broadcaster.hidden %}
              <span class="badge bg-warning">
                <i class="bi bi-eye-slash me-1"></i>Hidden from Public
              </span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        {% for message in messages %}
          {{ message }}
        {% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endif %}
  {% endwith %}

  <div class="row">
    <!-- Main Content -->
    <div class="col-xl-8">
      <!-- Stream Channel Section -->
      {% set stream_channels = channels | selectattr('main_video_type.name', 'equalto', 'Live') | list %}
      <div class="section-header">
        <h3><i class="bi bi-broadcast me-2"></i>Live Stream Channel</h3>
        <p class="text-muted mb-0">Primary Twitch channel for live streaming</p>
      </div>

      {% if stream_channels %}
        {% for channel in stream_channels %}
          <div class="card channel-card twitch mb-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center mb-2">
                    <h5 class="card-title mb-0 me-3">{{ channel.name }}</h5>
                    <span class="badge platform-badge {{ channel.platform_name.lower() }} me-2">{{ channel.platform_name }}</span>
                    <span class="badge channel-type-badge stream">Live Stream</span>
                  </div>
                  <div class="row">
                    <div class="col-md-6">
                      <small class="text-muted">Channel ID: {{ channel.platform_channel_id }}</small><br>
                      <small class="text-muted">Platform Ref: {{ channel.platform_ref }}</small>
                    </div>
                    <div class="col-md-6">
                      <small class="text-muted">Last Active: {{ channel.last_active if channel.last_active else 'Never' }}</small><br>
                    </div>
                  </div>
                </div>
                <div class="dropdown">
                  <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                          data-bs-toggle="dropdown" aria-expanded="false">
                    Actions
                  </button>
                  <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="{{ url_for('channel.channel_get_videos', channel_id=channel.id) }}">
                      <i class="bi bi-collection-play me-2"></i>View Channel
                    </a></li>
                    <li><a class="dropdown-item" href="{{ url_for('broadcaster.broadcaster_events', broadcaster_id=broadcaster.id, channel_id=channel.id) }}">
                      <i class="bi bi-calendar-event me-2"></i>View Events
                    </a></li>
                    {% if user_service.has_permission(current_user, ["admin"]) or user_service.has_broadcaster_id(current_user, broadcaster.id) %}
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item" href="{{ url_for('channel.channel_fetch_details', channel_id=channel.id) }}">
                        <i class="bi bi-arrow-clockwise me-2"></i>Update Details
                      </a></li>
                      <li><a class="dropdown-item" href="{{ url_for('channel.channel_fetch_videos', channel_id=channel.id) }}">
                        <i class="bi bi-download me-2"></i>Fetch Latest
                      </a></li>
                      <li><hr class="dropdown-divider"></li>
                      <li><a class="dropdown-item text-danger hold-to-delete-dropdown" 
                            data-channel-id="{{ channel.id }}"
                            data-delete-url="{{ url_for('channel.channel_delete', channel_id=channel.id) }}"
                            href="#" onclick="return false;">
                        <div class="progress-overlay"></div>
                        <div class="dropdown-content">
                          <i class="bi bi-trash me-2"></i><span class="delete-text">Hold to Delete</span>
                        </div>
                      </a></li>
                    {% endif %}
                  </ul>
                </div>
              </div>
              
              <!-- Stream Channel Settings -->
              {% if user_service.has_permission(current_user, ["admin", "mod"]) or user_service.has_broadcaster_id(current_user, broadcaster.id) or user_service.is_moderator(current_user, broadcaster.id) %}
                <div class="mt-3 p-3 border rounded">
                  <h6 class="mb-3">Stream Settings</h6>
                  <div class="row">
                    <div class="col-md-4">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" 
                               id="chat_collection_enabled{{ channel.id }}" 
                               name="chat_collection_enabled"
                               {% if channel.settings and (channel.settings.chat_collection_enabled or channel.settings.content_queue_enabled) %}checked{% endif %}
                               hx-post="{{ url_for('channel.channel_settings_update', channel_id=channel.id) }}"
                               hx-target="#settings-feedback"
                               hx-indicator="#settings-spinner">
                        <label class="form-check-label" for="chat_collection_enabled{{ channel.id }}">
                          Chat Collection
                        </label>
                        <div class="form-text">Collect chat logs during streams</div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="form-check">
                        <input type="checkbox" class="form-check-input" 
                               id="content_queue_enabled{{ channel.id }}" 
                               name="content_queue_enabled"
                               {% if channel.settings and channel.settings.content_queue_enabled %}checked{% endif %}
                               hx-post="{{ url_for('channel.channel_settings_update', channel_id=channel.id) }}"
                               hx-target="#settings-feedback"
                               hx-indicator="#settings-spinner">
                        <label class="form-check-label" for="content_queue_enabled{{ channel.id }}">
                          Content Queue
                        </label>
                        <div class="form-text">Monitor chat for clip submissions</div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="main_video_type{{ channel.id }}" class="form-label">Channel Type</label>
                        <div class="form-text">Normally you do not change this</div>
                        <select id="main_video_type{{ channel.id }}" name="main_video_type" class="form-select form-select-sm"
                                hx-post="{{ url_for('channel.channel_settings_update', channel_id=channel.id) }}"
                                hx-target="#settings-feedback"
                                hx-indicator="#settings-spinner"
                                hx-trigger="change">
                          {% for video_type in video_types %}
                            <option value="{{ video_type.name }}" {% if channel.main_video_type == video_type %}selected{% endif %}>
                              {{ video_type.name }}
                            </option>
                          {% endfor %}
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="card add-channel-btn mb-4" data-bs-toggle="modal" data-bs-target="#addChannelModal" style="cursor: pointer;">
          <div class="card-body text-center py-4">
            <i class="bi bi-plus-circle display-4 text-muted mb-3"></i>
            <h5 class="text-muted">Add Twitch Stream Channel</h5>
            <p class="text-muted">Set up your primary streaming channel</p>
          </div>
        </div>
      {% endif %}

      <!-- VOD Channels Section -->
      {% set vod_channels = channels | rejectattr('main_video_type.name', 'equalto', 'Live') | list %}
      <div class="section-header">
        <h3><i class="bi bi-play-circle me-2"></i>Other Channels</h3>
        <p class="text-muted mb-0">Channels for video content and archives</p>
      </div>

      {% if vod_channels %}
        <div class="row">
          {% for channel in vod_channels | sort(attribute='name') %}
            <div class="col-lg-6 mb-4">
              <div class="card channel-card youtube h-100">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-2">
                        <h6 class="card-title mb-0 me-3">{{ channel.name }}</h6>
                        <span class="badge platform-badge {{ channel.platform_name.lower() }}">{{ channel.platform_name }}</span>
                      </div>
                      <small class="text-muted">{{ channel.platform_channel_id }}</small>
                    </div>
                    <div class="dropdown">
                      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                              data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{{ url_for('channel.channel_get_videos', channel_id=channel.id) }}">
                          <i class="bi bi-collection-play me-2"></i>View Channel
                        </a></li>
                        <li><a class="dropdown-item" href="{{ url_for('broadcaster.broadcaster_events', broadcaster_id=broadcaster.id, channel_id=channel.id) }}">
                          <i class="bi bi-calendar-event me-2"></i>View Events
                        </a></li>
                        {% if user_service.has_permission(current_user, ["admin"]) or user_service.has_broadcaster_id(current_user, broadcaster.id) %}
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item" href="{{ url_for('channel.channel_fetch_details', channel_id=channel.id) }}">
                            <i class="bi bi-arrow-clockwise me-2"></i>Update Details
                          </a></li>
                          <li><a class="dropdown-item" href="{{ url_for('channel.channel_fetch_videos', channel_id=channel.id) }}">
                            <i class="bi bi-download me-2"></i>Fetch Latest
                          </a></li>
                          <li><a class="dropdown-item" href="{{ url_for('channel.channel_fetch_videos_all', channel_id=channel.id) }}">
                            <i class="bi bi-cloud-download me-2"></i>Fetch All Videos
                          </a></li>
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item" href="#" onclick="showChannelLinkModal({{ channel.id }}, '{{ channel.name }}', {{ channel.source_channel.id if channel.source_channel else 'null' }}, '{{ channel.source_channel.name if channel.source_channel else '' }}'); return false;">
                            <i class="bi bi-diagram-3 me-2"></i>Manage Linking
                          </a></li>
                          {% if channel.source_channel %}
                            <li><a class="dropdown-item" href="#" onclick="showEnhancedLinkingModal({{ channel.id }}, '{{ channel.name }}', '{{ channel.source_channel.name }}'); return false;">
                              <i class="bi bi-link-45deg me-2"></i>Run Video Linking
                            </a></li>
                          {% endif %}
                          <li><hr class="dropdown-divider"></li>
                          <li><a class="dropdown-item text-danger hold-to-delete-dropdown" 
                                data-channel-id="{{ channel.id }}"
                                data-delete-url="{{ url_for('channel.channel_delete', channel_id=channel.id) }}"
                                href="#" onclick="return false;">
                            <div class="progress-overlay"></div>
                            <div class="dropdown-content">
                              <i class="bi bi-trash me-2"></i><span class="delete-text">Hold to Delete</span>
                            </div>
                          </a></li>
                        {% endif %}
                      </ul>
                    </div>
                  </div>
                  
                  {% if user_service.has_permission(current_user, ["admin"]) or user_service.has_broadcaster_id(current_user, broadcaster.id) %}
                    <div class="mb-3">
                      <label for="main_video_type_vod{{ channel.id }}" class="form-label small">Channel Type</label>
                      <select id="main_video_type_vod{{ channel.id }}" name="main_video_type" class="form-select form-select-sm"
                              hx-post="{{ url_for('channel.channel_settings_update', channel_id=channel.id) }}"
                              hx-target="#settings-feedback"
                              hx-indicator="#settings-spinner"
                              hx-trigger="change">
                        {% for video_type in video_types %}
                          <option value="{{ video_type.name }}" {% if channel.main_video_type == video_type %}selected{% endif %}>
                            {{ video_type.name }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  {% else %}
                    <div class="mb-2">
                      <small class="text-muted">Channel Type: {{ channel.main_video_type.name if channel.main_video_type else 'Not set' }}</small>
                    </div>
                  {% endif %}
                  
                  {% if channel.source_channel %}
                    <div class="alert alert-info py-2 mb-0">
                      <i class="bi bi-link-45deg me-2"></i>
                      <small>Linked to: {{ channel.source_channel.name }}</small>
                    </div>
                  {% else %}
                    <div class="alert alert-warning py-2 mb-0">
                      <i class="bi bi-exclamation-triangle me-2"></i>
                      <small>No source channel linked</small>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="card add-channel-btn mb-4" data-bs-toggle="modal" data-bs-target="#addChannelModal" style="cursor: pointer;">
          <div class="card-body text-center py-4">
            <i class="bi bi-plus-circle display-4 text-muted mb-3"></i>
            <h5 class="text-muted">Add YouTube VOD Channel</h5>
            <p class="text-muted">Add channels for video content and stream archives</p>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-xl-4">
      {% if user_service.has_permission(current_user, ["admin"]) or user_service.has_broadcaster_id(current_user, broadcaster.id) %}
        <!-- Management Actions -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Management</h5>
          </div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addChannelModal">
                <i class="bi bi-plus-circle me-2"></i>Add New Channel
              </button>
              <a href="{{ url_for('broadcaster.broadcaster_queue', broadcaster_id=broadcaster.id) }}" class="btn btn-primary">
                <i class="bi bi-list-task me-2"></i>Manage Clip Queue
              </a>
              <a href="{{ url_for('broadcaster.broadcaster_events', broadcaster_id=broadcaster.id) }}" class="btn btn-primary">
                <i class="bi bi-calendar-event me-2"></i>View All Events
              </a>
              <button id="delete-broadcaster-btn" class="btn btn-outline-danger hold-to-delete" 
                      data-delete-url="{{ url_for('broadcaster.broadcaster_delete', broadcaster_id=broadcaster.id) }}">
                <div class="progress-overlay"></div>
                <div class="btn-content">
                  <i class="bi bi-trash me-2"></i><span class="btn-text">Delete Broadcaster</span>
                </div>
              </button>
            </div>
          </div>
        </div>
      {% endif %}

      {% if user_service.has_permission(current_user, ["admin", "mod"]) or user_service.has_broadcaster_id(current_user, broadcaster.id) or user_service.is_moderator(current_user, broadcaster.id) %}
        <!-- Broadcaster Settings -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-person-gear me-2"></i>Broadcaster Settings</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="profile_image_url" class="form-label">Profile Image URL</label>
              <input type="url" class="form-control" 
                     id="profile_image_url" 
                     name="profile_image_url"
                     value="{{ broadcaster.profile_image_url if broadcaster.profile_image_url else '' }}" 
                     placeholder="https://example.com/image.jpg"
                     hx-post="{{ url_for('broadcaster.broadcaster_settings_update', broadcaster_id=broadcaster.id) }}"
                     hx-target="#settings-feedback"
                     hx-indicator="#settings-spinner"
                     hx-trigger="change">
              <div class="form-text">URL to your profile image (will be displayed as a circle)</div>
            </div>
            
            {% if user_service.has_permission(current_user, ["admin"]) or user_service.has_broadcaster_id(current_user, broadcaster.id) %}
              <div class="form-check">
                <input type="checkbox" class="form-check-input" 
                       id="hidden" 
                       {% if broadcaster.hidden %}checked{% endif %}
                       hx-post="{{ url_for('broadcaster.broadcaster_settings_update', broadcaster_id=broadcaster.id) }}"
                       hx-target="#settings-feedback"
                       hx-indicator="#settings-spinner">
                <label class="form-check-label" for="hidden">
                  Hide from Public
                </label>
                <div class="form-text">Only visible to admins and the broadcaster</div>
              </div>
            {% endif %}
          </div>
        </div>

        <!-- Bot Integration -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-robot me-2"></i>Bot Integration</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="discord_channel_id" class="form-label">Discord Channel ID</label>
              <input type="number" class="form-control" 
                     id="discord_channel_id" 
                     value="{{ broadcaster.settings.linked_discord_channel_id if broadcaster.settings else '' }}" 
                     placeholder="Enter Discord Channel ID"
                     hx-post="{{ url_for('broadcaster.broadcaster_settings_update', broadcaster_id=broadcaster.id) }}"
                     hx-target="#settings-feedback"
                     hx-indicator="#settings-spinner"
                     hx-trigger="change">
              <div class="form-text">
                <a href="https://discord.com/oauth2/authorize?client_id=1359399600733290586" target="_blank">Add the bot</a> 
                to your server, then use <code>/verify</code> to get the channel ID.
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Log Import -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>Chat Log Import</h5>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="channel-select" class="form-label">Target Channel</label>
              <select id="channel-select" class="form-select" required>
                <option value="">Choose a channel...</option>
                {% for channel in broadcaster.channels if channel.main_video_type.name == 'Live' %}
                  <option value="{{ channel.id }}">{{ channel.name }}</option>
                {% endfor %}
              </select>
            </div>
            
            <div class="mb-3">
              <label for="chatlog-files" class="form-label">Chat Log Files</label>
              <input type="file" id="chatlog-files" class="form-control" multiple accept=".log,.txt">
              <div class="form-text">Select .log or .txt files from Chatterino or similar</div>
            </div>
            
            <div class="mb-3">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="events-only" name="events_only">
                <label class="form-check-label" for="events-only">
                  Import Events Only
                </label>
                <div class="form-text">Only import channel events (live/offline, subs, raids, etc.) and skip chat messages</div>
              </div>
            </div>
            
            <div id="file-list" class="mb-3" style="display: none;">
              <h6>Selected Files:</h6>
              <ul id="selected-files" class="list-group list-group-flush"></ul>
            </div>
            
            <button type="button" id="upload-chatlogs" class="btn btn-success w-100" disabled>
              <i class="bi bi-upload me-2"></i>Upload Chat Logs
            </button>
            
            <div id="upload-progress" class="mt-3" style="display: none;">
              <div class="progress">
                <div id="upload-progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
              </div>
              <div id="upload-status" class="mt-2"></div>
            </div>
            
            <div id="upload-results" class="mt-3"></div>
          </div>
        </div>
      {% endif %}
    </div>
  </div>


  <!-- Feedback and Loading -->
  <div id="settings-feedback"></div>
  <div id="settings-spinner" class="htmx-indicator">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
  </div>
</div>

<!-- Add Channel Modal -->
<div class="modal fade" id="addChannelModal" tabindex="-1" aria-labelledby="addChannelModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addChannelModalLabel">Add New Channel</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form action="{{ url_for('channel.channel_create') }}" method="post">
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <input type="hidden" name="broadcaster_id" value="{{ broadcaster.id }}">
          <input type="hidden" id="channel_id" name="channel_id" value="">

          <div class="mb-3">
            <label for="platform_name" class="form-label">Platform</label>
            <select id="platform_name" name="platform_name" class="form-select" onchange="toggleTwitchLookup()">
              {% for platform in platforms %}
                <option value="{{ platform.name }}">{{ platform.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="channel_type" class="form-label">Channel Type</label>
            <select id="channel_type" name="channel_type" class="form-select">
              {% for video_type in video_types %}
                <option value="{{ video_type.name }}">{{ video_type.name }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label for="name" class="form-label">Display Name</label>
            <input type="text" id="name" name="name" class="form-control" 
                   pattern="[A-Za-z0-9_.][A-Za-z0-9_. ]*" 
                   placeholder="Channel Display Name" 
                   required>
          </div>
          
          <div id="twitch-lookup-container" style="display: none;" class="mb-3">
            <label for="twitch_username" class="form-label">Twitch Username</label>
            <div class="input-group">
              <input type="text" id="twitch_username" class="form-control" placeholder="Enter Twitch username">
              <button type="button" id="lookup-twitch-id" class="btn btn-outline-primary">Look up</button>
              <span id="twitch-lookup-status" class="ms-2 d-flex align-items-center" style="display: none;"></span>
            </div>
            <div class="form-text">Enter the Twitch username to fetch the channel ID</div>
          </div>
          
          <div class="mb-3">
            <label for="platform_ref" class="form-label">Channel ID</label>
            <input type="text" id="platform_ref" name="platform_ref" class="form-control" 
                   pattern="[A-Za-z0-9_.][A-Za-z0-9_.]*" 
                   placeholder="Platform-specific channel ID" 
                   required>
            <div class="form-text">For YouTube: remove @ from handle, for Twitch: use username or ID</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Add Channel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Channel Link Management Modal -->
<div class="modal fade" id="channelLinkModal" tabindex="-1" aria-labelledby="channelLinkModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="channelLinkModalLabel">Manage Channel Link</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="channel-link-modal-content">
          <p class="mb-3">Set the source channel for video linking. Videos will be matched from the source channel.</p>
          
          <form id="channelLinkForm" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="mb-3">
              <label for="modal_link_channel_id" class="form-label">Source Channel</label>
              <select id="modal_link_channel_id" name="link_channel_id" class="form-select">
                <option value="None">None (No source channel)</option>
              </select>
              <div class="form-text">Choose which channel serves as the source for video linking</div>
            </div>
            
            <div id="channel-link-preview" class="mt-3"></div>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="saveChannelLinkBtn">
          <i class="bi bi-check-circle me-2"></i>Save Channel Link
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Video Linking Modal -->
<div class="modal fade" id="enhancedLinkingModal" tabindex="-1" aria-labelledby="enhancedLinkingModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="enhancedLinkingModalLabel">Enhanced Video Linking</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="linking-modal-content">
          <p class="mb-3">Configure and run enhanced video linking with title date parsing.</p>
          
          <form id="enhancedLinkingForm" method="post">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            
            <div class="row">
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="modal_margin_sec" class="form-label">Duration Margin (seconds)</label>
                  <input type="number" class="form-control" id="modal_margin_sec" name="margin_sec" value="2" min="0" max="20">
                  <div class="form-text">±seconds tolerance for video duration</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="modal_min_duration" class="form-label">Min Duration (seconds)</label>
                  <input type="number" class="form-control" id="modal_min_duration" name="min_duration" value="300" min="60">
                  <div class="form-text">Skip videos shorter than this</div>
                </div>
              </div>
              <div class="col-md-4">
                <div class="mb-3">
                  <label for="modal_date_margin_hours" class="form-label">Date Margin (hours)</label>
                  <input type="number" class="form-control" id="modal_date_margin_hours" name="date_margin_hours" value="48" min="1" max="168">
                  <div class="form-text">Max time difference for date matches</div>
                </div>
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="runLinkingBtn">
          <i class="bi bi-play-circle me-2"></i>Run Video Linking
        </button>
      </div>
    </div>
  </div>
</div>



<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="deleteConfirmationModalLabel">
          <i class="bi bi-exclamation-triangle me-2"></i>Confirm Deletion
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger mb-3">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>Warning:</strong> This action cannot be undone!
        </div>
        <p id="deleteConfirmationText"></p>
        <p class="mb-0">If transcriptions has been enabled, it has been a lot of computing power to generate them and <strong> the dev will be sad :(</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
          <i class="bi bi-trash me-2"></i>Yes, Delete Permanently
        </button>
      </div>
    </div>
  </div>
</div>

<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
{% endblock %}

{% block scripts %}
<script type="module">
  import init, { 
    init_broadcaster_edit,
    toggle_twitch_lookup,
    lookup_twitch_id,
    show_channel_link_modal,
    show_enhanced_linking_modal
  } from "{{ url_for('static', filename='wasm/yappr_wasm.js', v=version) }}";
  
  async function run() {
    await init();
    
    // Initialize the broadcaster edit functionality
    init_broadcaster_edit();
    
    // Make functions available globally for onclick handlers
    window.toggleTwitchLookup = toggle_twitch_lookup;
    window.lookupTwitchId = lookup_twitch_id;
    window.showChannelLinkModal = show_channel_link_modal;
    window.showEnhancedLinkingModal = show_enhanced_linking_modal;
  }
  
  run();
</script>

<script>
  // Hold-to-delete functionality
  document.addEventListener('DOMContentLoaded', function() {
    const deleteBtn = document.getElementById('delete-broadcaster-btn');
    if (!deleteBtn) return;
    
    const progressOverlay = deleteBtn.querySelector('.progress-overlay');
    const btnText = deleteBtn.querySelector('.btn-text');
    const deleteUrl = deleteBtn.getAttribute('data-delete-url');
    
    let holdTimer = null;
    let progressInterval = null;
    let progress = 0;
    const holdDuration = 5000; // 5 seconds
    
    function startHold() {
      progress = 0;
      btnText.textContent = 'Hold to Delete... (5s)';
      deleteBtn.classList.add('completing');
      
      progressInterval = setInterval(() => {
        progress += 100; // 100ms increments
        const percentage = (progress / holdDuration) * 100;
        progressOverlay.style.width = percentage + '%';
        
        const remaining = Math.ceil((holdDuration - progress) / 1000);
        btnText.textContent = `Hold to Delete... (${remaining}s)`;
        
        if (progress >= holdDuration) {
          completeDelete();
        }
      }, 100);
      
      holdTimer = setTimeout(completeDelete, holdDuration);
    }
    
    function cancelHold() {
      if (holdTimer) {
        clearTimeout(holdTimer);
        holdTimer = null;
      }
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      
      progress = 0;
      progressOverlay.style.width = '0%';
      btnText.textContent = 'Hold to Delete Broadcaster';
      deleteBtn.classList.remove('completing');
    }
    
    function completeDelete() {
      if (holdTimer) {
        clearTimeout(holdTimer);
        holdTimer = null;
      }
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      
      progressOverlay.style.width = '100%';
      btnText.textContent = 'Confirm Deletion';
      
      // Show confirmation modal with broadcaster-specific content
      showDeleteConfirmation(
        `You are about to permanently delete the broadcaster "{{ broadcaster.name }}" and all associated data including:
         • All channels ({{ channels | length }} channel{{ 's' if channels | length != 1 else '' }})
         • All video transcriptions and metadata
         • All chat logs and user interactions
         • All queue entries and moderation data`,
        deleteUrl
      );
      
      // Reset button state
      setTimeout(() => {
        cancelHold();
      }, 500);
    }
    
    // Mouse events
    deleteBtn.addEventListener('mousedown', startHold);
    deleteBtn.addEventListener('mouseup', cancelHold);
    deleteBtn.addEventListener('mouseleave', cancelHold);
    
    // Touch events for mobile
    deleteBtn.addEventListener('touchstart', function(e) {
      e.preventDefault();
      startHold();
    });
    deleteBtn.addEventListener('touchend', function(e) {
      e.preventDefault();
      cancelHold();
    });
    deleteBtn.addEventListener('touchcancel', function(e) {
      e.preventDefault();
      cancelHold();
    });
    
    // Prevent context menu on long press
    deleteBtn.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });
  });
  
  // Hold-to-delete functionality for channel delete buttons
  document.querySelectorAll('.hold-to-delete-dropdown').forEach(function(deleteItem) {
    const progressOverlay = deleteItem.querySelector('.progress-overlay');
    const deleteText = deleteItem.querySelector('.delete-text');
    const deleteUrl = deleteItem.getAttribute('data-delete-url');
    const channelId = deleteItem.getAttribute('data-channel-id');
    
    let holdTimer = null;
    let progressInterval = null;
    let progress = 0;
    const holdDuration = 3000; // 3 seconds for channels (shorter than broadcaster)
    
    function startChannelHold() {
      progress = 0;
      deleteText.textContent = 'Hold to Delete... (3s)';
      deleteItem.classList.add('completing');
      
      progressInterval = setInterval(() => {
        progress += 100; // 100ms increments
        const percentage = (progress / holdDuration) * 100;
        progressOverlay.style.width = percentage + '%';
        
        const remaining = Math.ceil((holdDuration - progress) / 1000);
        deleteText.textContent = `Hold to Delete... (${remaining}s)`;
        
        if (progress >= holdDuration) {
          completeChannelDelete();
        }
      }, 100);
      
      holdTimer = setTimeout(completeChannelDelete, holdDuration);
    }
    
    function cancelChannelHold() {
      if (holdTimer) {
        clearTimeout(holdTimer);
        holdTimer = null;
      }
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      
      progress = 0;
      progressOverlay.style.width = '0%';
      deleteText.textContent = 'Hold to Delete';
      deleteItem.classList.remove('completing');
    }
    
    function completeChannelDelete() {
      if (holdTimer) {
        clearTimeout(holdTimer);
        holdTimer = null;
      }
      if (progressInterval) {
        clearInterval(progressInterval);
        progressInterval = null;
      }
      
      progressOverlay.style.width = '100%';
      deleteText.textContent = 'Confirm Deletion';
      
      // Get channel name from the card
      const channelCard = deleteItem.closest('.channel-card');
      const channelName = channelCard ? channelCard.querySelector('.card-title').textContent.trim() : 'this channel';
      
      // Show confirmation modal with channel-specific content
      showDeleteConfirmation(
        `You are about to permanently delete the channel "${channelName}" and all associated data including:
         • All video transcriptions and metadata
         • All chat logs and user interactions
         • All queue entries related to this channel`,
        deleteUrl
      );
      
      // Reset button state
      setTimeout(() => {
        cancelChannelHold();
      }, 500);
    }
    
    // Mouse events
    deleteItem.addEventListener('mousedown', function(e) {
      e.preventDefault();
      startChannelHold();
    });
    deleteItem.addEventListener('mouseup', function(e) {
      e.preventDefault();
      cancelChannelHold();
    });
    deleteItem.addEventListener('mouseleave', function(e) {
      cancelChannelHold();
    });
    
    // Touch events for mobile
    deleteItem.addEventListener('touchstart', function(e) {
      e.preventDefault();
      startChannelHold();
    });
    deleteItem.addEventListener('touchend', function(e) {
      e.preventDefault();
      cancelChannelHold();
    });
    deleteItem.addEventListener('touchcancel', function(e) {
      e.preventDefault();
      cancelChannelHold();
    });
    
    // Prevent context menu on long press
    deleteItem.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });
  });
  
  // Generic delete confirmation function
  window.showDeleteConfirmation = function(message, deleteUrl) {
    const confirmationText = document.getElementById('deleteConfirmationText');
    confirmationText.innerHTML = message.replace(/\n/g, '<br>').replace(/•/g, '&bull;');
    
    const confirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
    confirmModal.show();
    
    // Remove any existing event listeners and add new one
    const confirmBtn = document.getElementById('confirmDeleteBtn');
    const newConfirmBtn = confirmBtn.cloneNode(true);
    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
    
    newConfirmBtn.addEventListener('click', function() {
      window.location.href = deleteUrl;
    });
  };
</script>
{% endblock %}