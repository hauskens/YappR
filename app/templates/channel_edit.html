{% extends 'base.html' %}

{% block content %}
<style>
.title-truncate {
  max-width: 30vw;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  display: inline-block;
  vertical-align: top;
}
</style>
  <div class="container">
    <h1>Videos on Channel: {{ channel.name }}</h1>
    {% if current_user.is_anonymous == False and (user_service.has_permission(current_user, ["admin"]) or user_service.has_broadcaster_id(current_user, channel.broadcaster_id) or user_service.is_moderator(current_user, channel.broadcaster_id)) %}
      <a class="btn btn-primary" data-bs-toggle="collapse" href="#collapseManageChannel" role="button" aria-expanded="false" aria-controls="collapseExample">
        Some admin buttons...
      </a>
      <div class="collapse" id="collapseManageChannel">
        <hr>
        <!-- Enhanced Video Linking -->
        <div class="mb-3">
          <button type="button" class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#linkingOptions" aria-expanded="false" aria-controls="linkingOptions">
            <i class="bi bi-link-45deg me-2"></i>Bulk Video Linking
          </button>
          <div class="collapse mt-3" id="linkingOptions">
            <div class="card">
              <div class="card-body">
                <h6 class="card-title">Link Videos based on title parsing and duration matching</h6>
                <p class="card-text text-muted small">
                  Uses duration matching + title date parsing to link videos between channels.
                  {% if channel.source_channel %}
                    Will link videos from <strong>{{ channel.source_channel.name }}</strong>.
                  {% else %}
                    <span class="text-warning">No source channel configured.</span>
                  {% endif %}
                </p>
                
                {% if channel.source_channel %}
                <form action="{{ url_for('channel.channel_bulk_auto_link', channel_id=channel.id) }}" method="post" class="mt-3">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                  
                  <div class="row">
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="bulk_margin_sec" class="form-label">Duration Margin (seconds)</label>
                        <input type="number" class="form-control form-control-sm" id="bulk_margin_sec" name="margin_sec" value="10" min="0" max="20">
                        <div class="form-text">Â±seconds tolerance for video duration</div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="bulk_min_duration" class="form-label">Min Duration (seconds)</label>
                        <input type="number" class="form-control form-control-sm" id="bulk_min_duration" name="min_duration" value="300" min="60">
                        <div class="form-text">Skip videos shorter than this</div>
                      </div>
                    </div>
                    <div class="col-md-4">
                      <div class="mb-3">
                        <label for="bulk_date_margin_hours" class="form-label">Date Margin (hours)</label>
                        <input type="number" class="form-control form-control-sm" id="bulk_date_margin_hours" name="date_margin_hours" value="48" min="1" max="168">
                        <div class="form-text">Max time difference for date matches</div>
                      </div>
                    </div>
                  </div>
                  
                  <button type="submit" class="btn btn-success" onclick="return confirm('This will automatically link all videos where BOTH Duration AND Date matches are found. No manual confirmation required. Continue?')">
                    <i class="bi bi-lightning-fill me-2"></i>Bulk Auto-Link (Duration + Date Matches Only)
                  </button>
                </form>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
    <hr>
    {% if current_user.is_anonymous == False and (user_service.has_permission(current_user, ["admin", "mod"]) or user_service.has_broadcaster_id(current_user, channel.broadcaster_id) or user_service.is_moderator(current_user, channel.broadcaster_id)) %}
        <a class="btn btn-primary" onclick="return confirm('This will look new videos on this channel, and results is instant. Its totally fine to use, just dont spam click it')" href="{{ url_for('channel.channel_fetch_videos', channel_id=channel.id) }}">Look for new videos on channel</a>
    {% endif %}
    {% if current_user.is_anonymous == False and (user_service.has_permission(current_user, ["admin"]) or user_service.has_broadcaster_id(current_user, channel.broadcaster_id)) %}
        <a class="btn btn-primary" onclick="return confirm('This will look all videos on this channel, and results is instant. Its totally fine to use, just dont spam click it')" href="{{ url_for('channel.channel_fetch_videos_all', channel_id=channel.id) }}">Look for all videos on channel</a>
    {% endif %}
    <hr>
    <p>Videos on channel: {{ videos|length }}, Videos with high quality transcriptions: {{ transcription_count }}</p>
    <table class="table table-striped">
      <thead>
        <tr>
          <th scope="col">Thumbnail</th>
          <th scope="col">Title</th>
          <th scope="col">Duration</th>
          <th scope="col">Transcriptions</th>
          <th scope="col">Status</th>
          <th scope="col">Linked Status</th>
          <th scope="col">Published</th>
          <th scope="col">Estimated Upload</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for video in videos %}
        {% if video.active == true %}
        <tr>
          <td>
                  <img src="{{url_for('root.index')}}thumbnails/{{video.id}}" alt="" style="max-width:100%; max-height:250px;">
          </td>
          <td><span class="title-truncate" title="{{ video.title }}">{{ video.title }}</span></td>
          <td>{{ video_service.get_duration_str(video) }}</td>
          <td> 
            {% if video.transcriptions|length == 0 and video.active == true and not video.source_video %}
              {% if current_user.is_anonymous == False and (user_service.has_permission(current_user, ["admin", "mod"]) or user_service.has_broadcaster_id(current_user, channel.broadcaster_id) or user_service.is_moderator(current_user, channel.broadcaster_id)) %}
                  <a class="btn btn-primary" onclick="return confirm('After you put this in queue, please have patience, task runs on server and will take a while.')" title="Run in background: This will queue up full processing of video and will take some time depending on how much is in queue and how long the video is, you should expect a wait time of at least 5 min for YT, and 15 min for Twitch." role="button" href="{{ url_for('video_process_full', video_id=video.id) }}">Start full processing</a>
              {% endif %}
            {% endif %}
            {% for t in video.transcriptions %}
                {{ 'Processed' if t.processed else 'Not processed' }}
            {% endfor %}</td>
          <td>{% if video.audio.filename is defined %}Has audio attached{%elif video.source_video.id is defined%}<a href="{{ url_for('video.video_edit', video_id=video.source_video_id) }}">Linked with {{video.source_video.channel.platform_name}}</a>{% endif %}</td>
          <td>
            {% if video.source_video %}
              <span class="badge bg-success">
                <i class="bi bi-link-45deg me-1"></i>Linked
              </span>
              <br>
              <small class="text-muted">
                <a href="{{ url_for('video.video_edit', video_id=video.source_video.id) }}" class="text-decoration-none">
                  {{ video.source_video.title[:30] }}{% if video.source_video.title|length > 30 %}...{% endif %}
                </a>
              </small>
            {% else %}
              <span class="badge bg-secondary">
                <i class="bi bi-x-circle me-1"></i>Not Linked
              </span>
            {% endif %}
          </td>
          <td>{{ video.uploaded }}</td>
          <td>{{ video.estimated_upload_time if video.estimated_upload_time else 'N/A' }}</td>
          <td>
            <div class="container mb-2">
              <a class="btn btn-primary" role="button" href="{{ url_for('video.video_edit', video_id=video.id) }}">Edit Video</a>
            </div>
            {% if current_user.is_anonymous == False and (user_service.has_permission(current_user, ["admin", "mod"]) or user_service.has_broadcaster_id(current_user, channel.broadcaster_id) or user_service.is_moderator(current_user, channel.broadcaster_id)) %}
              {% if video.segments|length == 0 and video.transcriptions|length != 0 %}
                <div class="container mb-2">
                  {% for t in video.transcriptions %}
                    {% if t.processed == false %}
                      <a class="btn btn-primary" role="button" title="Quick task that parses the transcription and makes it searchable" href="{{ url_for('video.parse_transcriptions', video_id=video.id) }}">Make searchable</a>
                    {% endif %}
                  {% endfor %}
                </div>
              {%endif%}
              {% if video.audio.filename is defined and video.transcriptions|length == 0 %}
                <a class="btn btn-primary" role="button" title="Transcribe audio, this will take long time depending on queue and video length" href="{{ url_for('video_process_audio', video_id=video.id) }}">Process audio</a>
              {% elif video.audio.filename is undefined %}
                <div class="container mb-2">
                  <a class="btn btn-primary" role="button" title="Download audio from {{ video.channel.platform_name }}, this may take a while depending on queue and video length" href="{{ url_for('video_fetch_audio', video_id=video.id) }}">Fetch audio from {{ video.channel.platform_name }}</a>                          
                </div>
              {% endif %}
            {% endif %}
          </td>
        </tr>{% endif %}
        {% endfor %}
      </tbody>
    </table>

    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-success" role="alert">
          {% for message in messages %}
            {{ message }}
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

  </div>
{% endblock %}
