{% extends 'base.html' %} {% block content %}
<div class="container">
  {% if current_user.is_anonymous == False and user_service.has_permission(current_user, ["admin"]) %}
    <h1>User: {{ user.name }}</h1>
    <p>
      Yes.. this interface is horrible.. and it's open source, you can help
      improve it ->
      <a href="https://github.com/hauskens/yappr"> repo</a>
    </p>

    <form action="{{ url_for('users.user_edit', user_id=user.id) }}" method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
      <div class="mb-3">
        <label for="name" class="form-label">Connect to broadcaster</label>
        <select id="broadcaster_id" name="broadcaster_id" class="form-select">
          {% if user.broadcaster_id is defined %}
          <option value="None">None</option>
          {% else %}
          <option value="None" selected>None</option>
          {% endif %} {% for broadcaster in broadcasters %} {% if
          user.broadcaster_id == broadcaster.id %}
          <option value="{{ broadcaster.id }}" selected>
            {{ broadcaster.name }}
          </option>
          {% else %}
          <option value="{{ broadcaster.id }}">{{ broadcaster.name }}</option>
          {% endif %} {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary">Update User</button>
    </form>
    <hr />
    <p>Current roles in channels:</p>
    {% if user.channel_roles %}
      {% set channels_with_roles = {} %}
      {% for channel_role in user.channel_roles %}
        {% if channel_role.active %}
          {% set channel_name = channel_role.channel.name %}
          {% if channel_name not in channels_with_roles %}
            {% set _ = channels_with_roles.update({channel_name: []}) %}
          {% endif %}
          {% set _ = channels_with_roles[channel_name].append(channel_role) %}
        {% endif %}
      {% endfor %}
      
      {% if channels_with_roles %}
        {% for channel_name, roles in channels_with_roles.items() %}
          <div class="mb-2">
            <strong>{{ channel_name }}:</strong>
            {% for role in roles %}
              {% set config = get_role_config(role.role) %}
              <span class="badge ms-1" 
                    style="background-color: {{ config.background_color }}; color: {{ config.text_color }};"
                    title="{{ config.description }}">
                {{ role.role }}
              </span>
            {% endfor %}
          </div>
        {% endfor %}
      {% else %}
        <p class="text-muted">No active channel roles</p>
      {% endif %}
    {% else %}
      <p class="text-muted">No channel roles assigned</p>
    {% endif %}
    
    <hr />
    <p>Global permissions:</p>
    {% if user.permissions %}
      {% for perm in user.permissions %}
        <span class="badge bg-dark me-1" title="Global permission">
          {{ perm.permission_type.name }}
        </span>
      {% endfor %}
    {% else %}
      <p class="text-muted">No global permissions</p>
    {% endif %} 
  {% endif %}
</div>
{% endblock %}
